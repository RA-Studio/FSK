<template>
    <div class="content">
        <step-block></step-block>
        <div class="info">
          <div class="container">
            <h2 class="h1 title">Оплата</h2>
            <div class="info-greytext">
                <svg width="50" height="50" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M40.2344 13.2812C40.2344 13.8203 40.6719 14.2578 41.2109 14.2578C41.75 14.2578 42.1875 13.8203 42.1875 13.2812C42.1875 12.7422 41.75 12.3047 41.2109 12.3047C40.6719 12.3047 40.2344 12.7422 40.2344 13.2812Z" fill="#D7D7D7"></path><path d="M44.1416 24.9989C44.1416 26.2498 44.0161 27.4983 43.7689 28.7099C43.661 29.2382 44.002 29.754 44.5303 29.8619C44.5963 29.8756 44.662 29.8821 44.7268 29.8821C45.1811 29.8821 45.5882 29.5628 45.6828 29.1005C45.9563 27.7604 46.0948 26.3806 46.0948 24.9989C46.0948 21.9239 45.4279 18.9649 44.1123 16.2038C43.8803 15.717 43.2978 15.5103 42.8107 15.7422C42.3235 15.9741 42.1172 16.557 42.3491 17.0442C43.5385 19.5405 44.1416 22.2169 44.1416 24.9989Z" fill="#D7D7D7"></path><path d="M29.8828 33.7891H28.9062V21.0938C28.9062 20.5544 28.4691 20.1172 27.9297 20.1172H20.1172C19.5778 20.1172 19.1406 20.5544 19.1406 21.0938V25C19.1406 25.5394 19.5778 25.9766 20.1172 25.9766H21.0938V33.7891H20.1172C19.5778 33.7891 19.1406 34.2262 19.1406 34.7656V38.6719C19.1406 39.2113 19.5778 39.6484 20.1172 39.6484H29.8828C30.4222 39.6484 30.8594 39.2113 30.8594 38.6719V34.7656C30.8594 34.2262 30.4222 33.7891 29.8828 33.7891ZM28.9062 37.6953H21.0938V35.7422H22.0703C22.6097 35.7422 23.0469 35.305 23.0469 34.7656V25C23.0469 24.4606 22.6097 24.0234 22.0703 24.0234H21.0938V22.0703H26.9531V34.7656C26.9531 35.305 27.3907 35.7422 27.9297 35.7422H28.9062V37.6953Z" fill="#D7D7D7"></path><path d="M25 18.1641C27.1538 18.1641 28.9062 16.4116 28.9062 14.2578C28.9062 12.104 27.1538 10.3516 25 10.3516C22.8462 10.3516 21.0938 12.104 21.0938 14.2578C21.0938 16.4116 22.8462 18.1641 25 18.1641ZM25 12.3047C26.0769 12.3047 26.9531 13.1809 26.9531 14.2578C26.9531 15.3347 26.0769 16.2109 25 16.2109C23.9231 16.2109 23.0469 15.3347 23.0469 14.2578C23.0469 13.1809 23.9231 12.3047 25 12.3047Z" fill="#D7D7D7"></path><path d="M25 0C11.5258 0 4.25859e-05 11.504 4.25859e-05 25C4.25859e-05 29.6101 1.32107 34.5127 3.54847 38.221L0.0500151 48.7148C-0.0667146 49.0654 0.0244566 49.4526 0.286145 49.7139C0.548978 49.9767 0.936551 50.0664 1.2856 49.9496L11.7794 46.4516C15.4873 48.6794 20.39 50 25 50C38.4777 50 50 38.4945 50 25C50 11.5223 38.4949 0 25 0V0ZM25 48.0469C20.5777 48.0469 15.8772 46.7419 12.426 44.556C12.1815 44.4012 11.8767 44.3604 11.5944 44.4546L2.52079 47.4792L5.54547 38.4056C5.63855 38.1271 5.60116 37.822 5.444 37.574C3.25818 34.1232 1.95317 29.4224 1.95317 25C1.95317 12.5072 12.5073 1.95312 25 1.95312C37.4928 1.95312 48.0469 12.5072 48.0469 25C48.0469 37.4928 37.4928 48.0469 25 48.0469Z" fill="#D7D7D7"></path></svg>
                Наиболее удобный и безопасный способ оплаты - онлайн-аккредитив от Сбербанк.
                Для его использования достаточно быть клиентом Сбербанка и иметь необходимые средства на счету.<br>
                Если вы не являетесь клиентом Сбербанка, вы можете воспользоваться Системой Безопасных Расчетов (СБР ДомКлик).
                Для использования этого сервиса свяжитесь с нашим специалистом по номеру +7 (812) 703-55-55.
            </div>
            <div class="info-withside">
              <div class="info-withside-content">
                <div class="info-load-row">Скачайте шаблон заявления на открытие  онлайн-аккредитива - он справа. </div>
                <div class="info-load-row">Распечатайте, заполните, и подпишите скачанное заявление. Отсканируйте или сфотографируйте документ и загрузите в соотвестующее окно. </div>
                <div class="info-load-row">Ожидайте извещения в своем интернет-банке (Сбербанк Онлайн) или в мобильном приложении Сбербанка и следуйте инструкциям.</div>
              </div>
              <div class="info-withside-side">
                <div class="info-withside-side-load" v-if="filesLoad.length === 0">
                    <svg width="56" height="76" viewBox="0 0 56 76" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="54.875" y="1" width="73.3105" height="53.8755" rx="1" transform="rotate(90 54.875 1)" stroke="#E94200" stroke-width="2"></rect><path d="M12.5977 24.3848L43.2797 24.3848" stroke="#E94200" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12.5977 35.5399L43.2797 35.54" stroke="#E94200" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12.5977 46.6986L20.9655 46.6986" stroke="#E94200" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12.5977 57.8573L20.9655 57.8573" stroke="#E94200" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20.9687 13.2261L34.9151 13.2261" stroke="#E94200" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M37.7025 59.6429C33.6333 59.6429 30.3347 56.3442 30.3347 52.275C30.3347 48.2059 33.6333 44.9072 37.7025 44.9072C41.7716 44.9072 45.0703 48.2059 45.0703 52.275C45.0703 56.3442 41.7716 59.6429 37.7025 59.6429Z" stroke="#E94200" stroke-width="2"></path></svg>
                    Ваше заявление на открытие аккредитива скоро сформируется. Ожидайте...
                </div>
                <div class="info-withside-side-download" v-if="filesLoad.length > 0" v-for="(link, index) in filesLoad">
                    <svg width="64" height="62" viewBox="0 0 64 62" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.5529 34.5415L0.630859 23.6196C0.761406 22.4398 1.0177 21.2773 1.39539 20.152L19.3891 30.5004L56.6326 9.14821L58.6258 11.8787L19.5529 34.5415Z" fill="#BEBEBE"></path><path d="M19.3832 38.5511L0.0515693 27.3017C-0.0171898 28.019 -0.0171898 28.7413 0.0515693 29.4587C0.0515693 37.9387 3.42021 46.0713 9.41644 52.0675C15.4127 58.0637 23.5453 61.4324 32.0252 61.4324C40.5052 61.4324 48.6378 58.0637 54.634 52.0675C60.6303 46.0713 63.9989 37.9387 63.9989 29.4587C64.0415 24.4035 62.8414 19.4152 60.5039 14.9327L19.3832 38.5511Z" fill="#BEBEBE"></path><path d="M54.0627 6.45278C53.1344 5.52442 52.1787 4.84181 51.3323 4.04997L19.3859 22.4533L4.09535 13.6612C3.54925 14.5895 3.00316 15.6817 2.48438 16.7466L19.2767 26.467L54.0627 6.45278Z" fill="#BEBEBE"></path><path d="M48.0295 1.88402C46.8129 1.18011 45.5545 0.550937 44.2615 0L19.387 14.3622L8.24671 8.19137C7.45488 9.01051 6.77226 9.93887 5.95312 10.9218L19.2778 18.5671L48.0295 1.88402Z" fill="#BEBEBE"></path></svg>
                    <span>
                        Ваш бланк заявления для открытия аккредитива.
                        <a :href="link" download="">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 10.3984L9.252 13.1504L12 10.3984" stroke="#E94200" stroke-width="1.3" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M9.24219 5V12.826" stroke="#E94200" stroke-width="1.3" stroke-linecap="round"></path><circle cx="9" cy="9" r="8.35" transform="rotate(90 9 9)" stroke="#E94200" stroke-width="1.3"></circle></svg>
                            Скачать
                        </a>
                    </span>
                </div>
                <slot v-for="(user, userKey) in users">
                    <components :is="`default-file`" :input="input" :inputKey="`${inputKey}${userKey}`" :key="`${inputKey}${userKey}`" v-for="(input, inputKey) in user.files" :multiple="false"></components>
                </slot>
              </div>
            </div>
              <div class="info-contract__btn-wrap"  v-if="sendOpen">
                <a class="info-contract__btn btn-new btn--bg" href="#" @click.prevent="sendFile()">Отправить заявление</a>
              </div>
          </div>
        </div>
    </div>
</template>
<script>
    import Vue from 'vue';
    import DefaultFile from './../../../../defaultFile.vue';
    import axios from 'axios';
    import qs from 'qs';

    import StepBlock from './../Step.vue';

    export default {
        data () {
            return {
                users: {},
                filesLoad: [],
                filesLoadType: 'заявлениеакредетив',
                sendOpen: false,
            }
        },
        created() {
            if(this.$store.getters.file1C) {
                for(let i in this.$store.getters.file1C[this.filesLoadType]) {
                    this.filesLoad.push(this.$store.getters.file1C[this.filesLoadType][i]);
                }
            }

            this.time = setInterval(() => {
                this.filesLoad = [];
                if(this.$store.getters.file1C) {
                    for(let i in this.$store.getters.file1C[this.filesLoadType]) {
                        this.filesLoad.push(this.$store.getters.file1C[this.filesLoadType][i]);
                    }
                }
            }, 5000);

            let usersIdentification = Object.keys(this.$store.getters.userInfo);
            let keyUser = usersIdentification[0];
            this.fileUserAdd(keyUser, this.$store.getters.userInfo[keyUser].data)
        },
        watch: {
            filesLoad: function (val) {
                this.sendOpen = val.length > 0;
            },
        },
        updated() {},
        components: {
            DefaultFile,
            StepBlock,
        },
        computed: {},
        methods: {
            fileUserAdd(iterator, info) {
                if(!iterator) return false;
                let lastName = info.lastName ? info.lastName.value : '';
                let firstName = info.firstName ? info.firstName.value : '';
                let middleName = info.middleName ? info.middleName.value : '';

                let nameFromFile = `${lastName} ${firstName[0]}.${middleName ? ` ${middleName[0]}.` : ''}`;

                this.$set(this.users, iterator, {
                    files: {
                        paymentCredit: { type: 'file', lable: `Заявление на аккредитив (${nameFromFile})`, class: '', files: {} },
                    },
                });
            },
            collectBlockFile() {
                let formDataFile = new FormData();
                for(let userID in this.users) {
                    for(let fieldKey in this.users[userID].files) {
                        let file = this.users[userID].files[fieldKey].files;
                        for(let i in file) {
                            if (Object.keys(file).length > 0) formDataFile.append(`files[${userID}][${fieldKey}][${i}]`, file[i]);
                        }
                    }
                }
                return formDataFile;
            },
            checkFile() {
                let error = false;
                for(let userID in this.users) {
                    for(let fieldKey in this.users[userID].files) {
                        let file = this.users[userID].files[fieldKey].files;
                        if (Object.keys(file).length === 0) error = true;
                    }
                }
                return error;
            },
            sendFile() {
                if(this.checkFile()) {
                    this.$store.dispatch('addGlobalMessege', {  type: 'error', message: 'Для отправки нужно загрузить все файлы' });
                    return false;
                }
                this.$store.commit('setLoader', { status: true });
                let form = this.collectBlockFile();
                let status = 9;
                form.append('dir', 'order');
                form.append('saveInOrder', 'Y');
                form.append(`reserve`, this.$store.getters.reserve);
                form.append(`status`, status);
                axios.post('/ajax/?act=Order.SaveFileOrder', form, { headers: { 'Content-Type': 'multipart/form-data'}}).then(response => {
                    this.$store.commit('setLoader', { status: false });
                    if(response.data.isSuccess) {
                        this.$store.dispatch('addGlobalMessege', {  type: 'ok', message: 'Ваши файлы успешно отправлены' });
                    } else {
                        this.$store.dispatch('addGlobalMessege', { type: 'error', message: response.data.message });
                    }
                }).catch(error => this.$store.commit('setLoader', { status: false }));
            },
        },
    };
</script>
